<mat-card class="create-card">
  <mat-card-header class="create-card__header">
    <button mat-icon-button type="button" aria-label="Back to orders" (click)="navigateBack()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="create-card__title">
      <h2>New Order</h2>
      <p>Capture the request details before routing it to fulfillment.</p>
    </div>
  </mat-card-header>

  <mat-card-content>
    <form class="create-form" [formGroup]="form" (ngSubmit)="submit()">
      <section class="create-form__section">
        <h3>Customer &amp; owner</h3>
        <div class="create-form__grid">
          <app-entity-lookup
            formControlName="customerId"
            [label]="'Customer'"
            [placeholder]="'Search by company or code'"
            [loader]="loadCustomers"
            [displayWith]="customerDisplay"
            [valueSelector]="customerValue"
            [hint]="'Type to filter customers'"
          ></app-entity-lookup>

          <app-entity-lookup
            formControlName="employeeId"
            [label]="'Account owner'"
            [placeholder]="'Search employee directory'"
            [loader]="loadEmployees"
            [displayWith]="employeeDisplay"
            [valueSelector]="employeeValue"
            [hint]="'Assign an internal owner'"
          ></app-entity-lookup>
        </div>
      </section>

      <section class="create-form__section">
        <h3>Dates &amp; logistics</h3>
        <div class="create-form__grid">
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Order date</mat-label>
            <input matInput [matDatepicker]="orderDatePicker" formControlName="orderDate" />
            <mat-datepicker-toggle matSuffix [for]="orderDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #orderDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Required by</mat-label>
            <input matInput [matDatepicker]="requiredDatePicker" formControlName="requiredDate" />
            <mat-datepicker-toggle matSuffix [for]="requiredDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #requiredDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Freight (USD)</mat-label>
            <input matInput type="number" formControlName="freight" min="0" step="0.01" />
          </mat-form-field>
        </div>
      </section>

      <section class="create-form__section create-form__section--products">
        <div class="products-header">
          <div class="products-header__title">
            <h3>Products</h3>
            <p>Search the catalog and configure the line items for this order.</p>
          </div>
          <div class="products-header__summary">
            <span class="products-header__summary-item">
              <mat-icon>inventory_2</mat-icon>
              {{ selectedCount() }} selected
            </span>
            <span class="products-header__summary-item">
              <mat-icon>attach_money</mat-icon>
              {{ selectedSubtotal() | currency:'USD':'symbol':'1.2-2' }}
            </span>
          </div>
        </div>

        <div class="products-panel">
          <div class="products-panel__catalog">
            <app-search-input
              class="products-panel__search"
              [label]="'Search catalog'"
              [placeholder]="'Filter by product name or supplier'"
              (searchChange)="onProductSearch($event)"
            ></app-search-input>

            <app-loading-state
              class="products-panel__state"
              [loading]="productCatalogLoading()"
              [error]="productError()"
              [retry]="retryProductCatalog"
              [loadingLabel]="'Loading productsâ€¦'"
              [retryLabel]="'Retry search'"
            >
              <div #catalogList class="products-panel__list" (scroll)="onCatalogScroll($event)">
                @if (productCatalog().length) {
                  @for (product of productCatalog(); track product.productId) {
                    <div class="products-panel__item">
                      <div class="products-panel__item-body">
                        <span class="products-panel__item-name">{{ product.productName }}</span>
                        <div class="products-panel__item-meta">
                          <span class="products-panel__price">
                            {{ (product.unitPrice ?? 0) | currency:'USD':'symbol':'1.2-2' }}
                          </span>
                          @if (product.unitsInStock !== null && product.unitsInStock !== undefined) {
                            <span class="products-panel__stock">
                              {{ product.unitsInStock }} in stock
                            </span>
                          }
                        </div>
                        @if (product.quantityPerUnit) {
                          <span class="products-panel__unit">{{ product.quantityPerUnit }}</span>
                        }
                      </div>
                      <button
                        mat-stroked-button
                        type="button"
                        color="primary"
                        (click)="addProduct(product)"
                        [disabled]="isProductSelected(product.productId)"
                      >
                        <mat-icon>
                          {{ isProductSelected(product.productId) ? 'check' : 'add' }}
                        </mat-icon>
                        {{ isProductSelected(product.productId) ? 'Added' : 'Add' }}
                      </button>
                    </div>
                  }
                } @else {
                  <div class="products-panel__empty">
                    <mat-icon>search_off</mat-icon>
                    <p>No products match your search.</p>
                  </div>
                }
              </div>
            </app-loading-state>
          </div>

          <div class="products-panel__selection">
            <div class="products-panel__selection-header">
              <h4>Selected products</h4>
              @if (hasSelection()) {
                <button mat-button type="button" color="warn" (click)="clearSelection()">
                  <mat-icon>delete_sweep</mat-icon>
                  Clear all
                </button>
              }
            </div>

            @if (hasSelection()) {
              <div class="selected-list">
                @for (item of selectedProducts(); track item.productId) {
                  <div class="selected-list__row">
                    <div class="selected-list__info">
                      <span class="selected-list__name">{{ item.productName }}</span>
                      @if (item.product?.quantityPerUnit) {
                        <span class="selected-list__meta">{{ item.product?.quantityPerUnit }}</span>
                      }
                    </div>

                    <div class="selected-list__inputs">
                      <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Qty</mat-label>
                        <input
                          matInput
                          type="number"
                          min="1"
                          [value]="item.quantity"
                          (input)="onQuantityInput(item.productId, $event)"
                        />
                      </mat-form-field>

                      <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Unit price</mat-label>
                        <input
                          matInput
                          type="number"
                          min="0"
                          step="0.01"
                          [value]="item.unitPrice"
                          (input)="onUnitPriceInput(item.productId, $event)"
                        />
                      </mat-form-field>

                      <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Discount %</mat-label>
                        <input
                          matInput
                          type="number"
                          min="0"
                          max="100"
                          step="1"
                          [value]="item.discount * 100"
                          (input)="onDiscountInput(item.productId, $event)"
                        />
                      </mat-form-field>
                    </div>

                    <div class="selected-list__total">
                      <span>{{ lineTotal(item) | currency:'USD':'symbol':'1.2-2' }}</span>
                      <button
                        mat-icon-button
                        type="button"
                        color="warn"
                        aria-label="Remove product"
                        (click)="removeProduct(item.productId)"
                      >
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="products-panel__empty products-panel__empty--selection">
                <mat-icon>inventory_2</mat-icon>
                <p>Add products to see them here.</p>
              </div>
            }
          </div>
        </div>
      </section>

      <section class="create-form__section">
        <h3>Shipping</h3>
        <div class="create-form__grid create-form__grid--stack">
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Ship name</mat-label>
            <input matInput formControlName="shipName" />
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Address</mat-label>
            <input matInput formControlName="shipAddress" />
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>City</mat-label>
            <input matInput formControlName="shipCity" />
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Region</mat-label>
            <input matInput formControlName="shipRegion" />
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Postal code</mat-label>
            <input matInput formControlName="shipPostalCode" />
          </mat-form-field>

          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Country</mat-label>
            <input matInput formControlName="shipCountry" />
          </mat-form-field>
        </div>
      </section>

      <section class="create-form__section">
        <h3>Notes</h3>
        <mat-form-field appearance="outline" class="create-form__notes" subscriptSizing="dynamic">
          <mat-label>Hand-off notes</mat-label>
          <textarea matInput rows="4" formControlName="notes"></textarea>
        </mat-form-field>
      </section>

      <div class="create-form__actions">
        <button mat-stroked-button type="button" (click)="navigateBack()" [disabled]="creating()">
          Cancel
        </button>
        <button mat-flat-button color="primary" type="submit" [disabled]="creating() || form.invalid">
          <mat-icon>check</mat-icon>
          Create order
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
